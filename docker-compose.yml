# =============================================================================
# LEVEL 1 OPTIMIZED: Production-ready Docker Compose
# Total memory target: <1.2GB (enforced)
# =============================================================================
version: '3.9'

services:
  # ---------------------------------------------------------------------------
  # PostgreSQL 16 - Optimized for NAS/low-memory environments
  # ---------------------------------------------------------------------------
  database:
    image: postgres:16-alpine
    container_name: inmobiliaria-db
    restart: unless-stopped
    
    environment:
      POSTGRES_DB: ${DB_NAME:-inmobiliaria}
      POSTGRES_USER: ${DB_USER:-app}
      POSTGRES_PASSWORD: ${DB_PASSWORD:?DB_PASSWORD is required}
      # Security: disable default postgres superuser
      POSTGRES_INITDB_ARGS: "--auth-host=scram-sha-256"
    
    volumes:
      - db_data:/var/lib/postgresql/data:rw
      - ./docker/postgres-init.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
      - ./docker/postgres-security.sql:/docker-entrypoint-initdb.d/02-security.sql:ro
    
    # Optimized PostgreSQL configuration for <384MB memory
    command:
      - "postgres"
      # Memory settings (total ~256MB target)
      - "-c" 
      - "shared_buffers=96MB"
      - "-c"
      - "effective_cache_size=192MB"
      - "-c"
      - "work_mem=2MB"
      - "-c"
      - "maintenance_work_mem=24MB"
      # Connection settings
      - "-c"
      - "max_connections=30"
      - "-c"
      - "superuser_reserved_connections=2"
      # Performance tuning
      - "-c"
      - "random_page_cost=1.1"
      - "-c"
      - "effective_io_concurrency=200"
      - "-c"
      - "checkpoint_completion_target=0.9"
      - "-c"
      - "wal_buffers=4MB"
      # Logging (slow queries)
      - "-c"
      - "log_min_duration_statement=500"
      - "-c"
      - "log_statement=ddl"
      # Security
      - "-c"
      - "password_encryption=scram-sha-256"
      - "-c"
      - "ssl=off"
    
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-app} -d ${DB_NAME:-inmobiliaria} -q"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 15s
    
    networks:
      - internal
    
    deploy:
      resources:
        limits:
          memory: 384M
          cpus: '1.0'
        reservations:
          memory: 128M

  # ---------------------------------------------------------------------------
  # KeyDB - Redis-compatible cache (optimized for low memory)
  # ---------------------------------------------------------------------------
  cache:
    image: eqalpha/keydb:alpine
    container_name: inmobiliaria-cache
    restart: unless-stopped
    
    command: >
      keydb-server
      --appendonly yes
      --appendfsync everysec
      --maxmemory 48mb
      --maxmemory-policy allkeys-lru
      --tcp-keepalive 60
      --timeout 300
      --databases 4
      --save ""
      --activedefrag yes
    
    volumes:
      - cache_data:/data:rw
    
    healthcheck:
      test: ["CMD", "keydb-cli", "ping"]
      interval: 5s
      timeout: 2s
      retries: 3
      start_period: 5s
    
    networks:
      - internal
    
    deploy:
      resources:
        limits:
          memory: 96M
          cpus: '0.5'
        reservations:
          memory: 32M

  # ---------------------------------------------------------------------------
  # Backend API - Hono + Bun
  # ---------------------------------------------------------------------------
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: inmobiliaria-api
    restart: unless-stopped
    
    ports:
      - "${PORT:-3000}:3000"
    
    environment:
      # Database
      DATABASE_URL: postgresql://${DB_USER:-app}:${DB_PASSWORD}@database:5432/${DB_NAME:-inmobiliaria}?connect_timeout=10&application_name=inmobiliaria-api
      
      # Cache
      REDIS_URL: redis://cache:6379/0
      
      # App
      PORT: 3000
      NODE_ENV: ${NODE_ENV:-production}
      
      # Security (required)
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET is required}
      
      # CORS
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:5173}
      
      # File storage
      UPLOAD_DIR: /app/uploads
      MAX_FILE_SIZE_MB: ${MAX_FILE_SIZE_MB:-10}
      
      # Rate limiting
      RATE_LIMIT_WINDOW_MS: ${RATE_LIMIT_WINDOW_MS:-60000}
      RATE_LIMIT_MAX: ${RATE_LIMIT_MAX:-100}
      AUTH_RATE_LIMIT_MAX: ${AUTH_RATE_LIMIT_MAX:-10}
      
      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-info}
      LOG_FORMAT: ${LOG_FORMAT:-json}
      
      # Version (for /health)
      APP_VERSION: ${APP_VERSION:-1.0.0}
    
    volumes:
      - uploads:/app/uploads:rw
    
    depends_on:
      database:
        condition: service_healthy
      cache:
        condition: service_healthy
    
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s
    
    networks:
      - internal
      - frontend
    
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.5'
        reservations:
          memory: 128M
    
    # Security: read-only root filesystem where possible
    read_only: false
    security_opt:
      - no-new-privileges:true

# =============================================================================
# Networks - Isolated internal network
# =============================================================================
networks:
  internal:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 172.28.0.0/24
  
  frontend:
    driver: bridge

# =============================================================================
# Volumes - Persistent data
# =============================================================================
volumes:
  db_data:
    driver: local
  cache_data:
    driver: local
  uploads:
    driver: local
